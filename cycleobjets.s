%%HP: T(0)A(R)F(.);
"%This file is licensed
%under GPL v2

%%CYCLEOBJETS.S
%FAIT AVANCER LES
%OBJETS EN DETECTANT
%LES COLLISIONS
%ET LES FAIT TOMBER
%LE CAS ECHEANT.

*CYCLEOBJETS

%ATTENTION ON N'APPELLE
%QU'UNE FOIS GARANTIE
%DONC SI PLUSIEURS OBJETS
%TOMBENT A LA FOIS
%IL PEUT Y AVOIR ERREUR.
%LC2OBPOSE
LC 05
P= 7
GOSUBL GARANTITBLOC4LIBRE

%POUR CHAQUE OBJET
%EN L'AIR:
%LC2OBJVOL
LC 04
GOSUBL GOLEVCb
%D1=C=1er OBJET
*CYCLEOBJSUIV
D=C A %POUR RETROUVER
DSRC  %L'OBJ APRES
DSRC
DSRC
DSRC
DSRC

D0=C
D1=C
C=0 A
C=C-1 A
C=DAT1 4
C=C+1 A
RTNC %C'ETAIT FFFFçFIN
C=C+1 A %BLOC LIBRE EN FAIT?
GONC CYCLE.OBJET.A.SOCCUPER
GOTO CYCLECHERCHEOBJSUIV

*CYCLE.OBJET.A.SOCCUPER
%DAT1=
%XXYY(4)
%COINPOS(1)
%N∞OBJ(2),ALT(1)
%DIRVOL(1)
%TOTAL:4+5p (çP=4)

%AVANCEOBJET
C=DAT1 4
B=C A
D1=D1+ 4
C=DAT1 S
D1=D1+ 4
A=DAT1 S

%CALCULER NVELLE POS
ST=1 0 %SI MEME CASE ALORS VALIDE
ST=0 1 %AINSI BITPLANSNESERONTPASMODIFIES
ST=1 3 %ET FLAG DEJA LA
GOSUB NEXTPOSOBJ
%VERIFIER CASE VALIDE
%ST0=VALIDEJOUEUR
%ST1=VALIDEMONSTRE
%ST2=OV&M
%ST3=OBJPOSE
?ST=0 0
GOYES LOBJETTOMBE

%SI OK AVANCER
C=B A
DAT0=C 4
D0=D0+ 4
DAT0=C S
D0=D0+ 3 %D0çTTL
ST=1 11
%REDUIRE TTL

?ST=1 3
GOYES BITVOLANTPASLAPEINE
GOSUBL METBITOBJETVOLANTDANSPLAN
*BITVOLANTPASLAPEINE

%FIN AVANCER OBJET
GOTO CYCLECHERCHEOBJSUIV

%...TESTER SI TTL=0
%SI OUI TOMBE
%SINON CASSOS OBJET SUIVANT
%!GOTO CYCLECHERCHEOBJSUIV

*LOBJETTOMBE
%ON SUPPOSE ACCESSIBLE
%PAR D0.

%COMME IL VA FALLOIR
%CHANGER BIT SUR PLAN
%ON LIS CASE MAINTENANT
C=DAT0 4
GOSUBL C4LISCASE

?ST=1 0
GOYES OUF.ONTOMBEBIEN
LC 85
GOLONG ERRORCb
*OUF.ONTOMBEBIEN

%LIBERER BLOC OBJETVOLANT
%GOSUB DECLAREBLOCD0LIBRE
C=DAT0 4
B=C A %XXYY POUR CASECOINçD0
C=0 A
C=C-1 A
C=C-1 A
DAT0=C 4

%EXTRAIRE NUMERO OBJ
%ET COINPOS POUR SUITE
D0=D0+ 4
C=DAT0 X
CSRC
R2=C S %R2=COINPOS

D=C B
DSRC
DSRC %AU FRAIS...

%APPELER ROUTINE POSER OBJ
GOSUB CASECOINB4R2sDONNED0
DSLC
DSLC
C=D B
DAT0=C B
ST=1 11 %FAUDRA REDESSINER
%FIN LOBJETTOMBE

?ST=1 3
GOYES BITPOSEPASLAPEINE
GOSUBL POSE.METBITPRESENCEOBJPOSE
*BITPOSEPASLAPEINE

%OBJETSUIVANT
*CYCLECHERCHEOBJSUIV
DSLC
DSLC
DSLC
DSLC
DSLC
C=D A %RETROUVER L'OBJ
C=C+9 A %4+5
GOTO CYCLEOBJSUIV
@
%****
%R3=C A %R3=lDXXYYh
%CSR A %C4=XXYY

%GOSUBL C4LISCASE
%%MAINTENANT
%%A=QGQD&3F B=QGQD
%%R0=çQG,R1=çQD
%%R2=000LR,R4x=NCASE
%%ST0=VALIDEJOUEUR
%%ST1=VALIDEMONSTRE
%%ST2=OV&M
%%ST3=OBJPOSE

%****
%*POSE.METBITPRESENCEOBJPOSE
%****


%*CALCULECOINSOL
%%ONVACALCULERLECOIN
%%ET LA CASE DEST
%C=R3 A %C0=DIR GRACE A CHECKMAIN&DIR
%A=C B
%ASRC %As=DIRMOI
%R1=A S %R1s=DIRMOI
%?ST=0 6 
%GOYES POZPASGAUCHE2
%C=C+1 B
%CBIT=0 2
%*POZPASGAUCHE2
%CSRC %Cs=COIN OBJ
%
%%C=R3 A %CASEd DEJA
%%CSR A %CASE  DEJA
%B=C A
%
%?ST=0 4
%GOYES ELOIGNEPAS
%GOSUB NEXTPOSOBJ
%*ELOIGNEPAS
%R2=C S %R2s=COIN
%C=B A %B4=NEWPOS
%CSLC
%R3=C A %R3a=DXXYY
%CSRC
%GOSUBL C4LISCASE
%C=R3 A %CSR A
%B=C A
%RTN
@"