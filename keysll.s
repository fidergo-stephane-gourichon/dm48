%%HP: T(0)A(R)F(.);
"%This file is licensed
%under GPL v2

%KEYSLL.S
%%AJOUTER VERIF PAS MONSTRE SUR LA MEME CASE
%%ALTITUDE F(FORCE,MASSE)

%%BUG: 'SI PRISE OBJ
%%VIDE CASE, AUTRE POSE
%%EN DESSOUS POSSIBLE'

GOIN5 KEY0

GOIN5 BADKEY
GOIN5 JETGAUCHE
GOIN5 JETDROITE
GOIN5 TOMBETOUT
GOIN5 BADKEY
GOIN5 BADKEY

GOIN5 BADKEY
GOIN5 SOLGAUCHELOIN
GOIN5 SOLDROITELOIN
GOIN5 TOURNE.G
GOIN5 STEPê
GOIN5 TOURNE.D

GOIN5 BADKEY
GOIN5 SOLGAUCHEPRES
GOIN5 SOLDROITEPRES
GOIN5 STEPé
GOIN5 STEPè
GOIN5 STEPç

GOIN5 CHANGEPOCHE
GOIN5 CHANGEPOCHE
GOIN5 CHANGEPOCHE
GOIN5 CHANGEPOCHE
GOIN5 CHANGEPOCHE
GOIN5 CHANGEPOCHE

GOIN5 SETVUEAUTOUR
GOIN5 SETVUEOBJ
GOIN5 BADKEY %GOIN5 SETVUESANTE
GOIN5 SETDODO
GOIN5 OFFKEY


GOIN5 BADKEY
GOIN5 BADKEY
GOIN5 BADKEY
GOIN5 BADKEY
GOIN5 SWAPMAINS


GOIN5 BADKEY
GOIN5 BADKEY
GOIN5 BADKEY
GOIN5 BADKEY
GOIN5 INCRMAIN


GOIN5 BADKEY
GOIN5 BADKEY
GOIN5 BADKEY
GOIN5 BADKEY
GOIN5 DECRMAIN


GOIN5 BADKEY
GOIN5 PUTQ0
GOIN5 PUTQ1
GOIN5 PHOTOKEY
GOIN5 MODIFQ

*BADKEY
%GOSBVL 01C31
%A=DAT0 W
%A=-A-1 W
%DAT0=A W
%%ST=0 8 %NO PERIODE
GOTO APK

*KEY0
%ICI PARCE QUE TEMPS
%…COUL….

%GOSBVL 01C31ÖA=DAT0 SÖA=-A-1 SÖDAT0=A SÖD0=D0+ 16ÖD0=D0+ 16ÖD0=D0+ 2ÖA=DAT0 SÖA=-A-1 SÖDAT0=A S
GOSBVL 01C31
A=DAT0 S
A=-A-1 S
DAT0=A S
D0=D0+ 16
D0=D0+ 16
D0=D0+ 2
A=DAT0 S
A=-A-1 S
DAT0=A S

ST=1 8 %PERIODE ECHUE
GOLONG APRESKEYS

*INCRMAIN
%LC5MDROITE
LC 00026
GOSUBL GONLEV1Ca
C=DAT1 B
?Cã0 B
GOYES INCMDPASVIDE
LC 07
*INCMDPASVIDE
C=C+1 B
GOTO MODMAIN
*DECRMAIN
%LC5MDROITE
LC 00026
GOSUBL GONLEV1Ca
C=DAT1 B
LA 08
?CãA B
GOYES DECMD4
LC 01
*DECMD4
C=C-1 B
GOC FINALEMENTPASDECR
*MODMAIN
DAT1=C B
*FINALEMENTPASDECR
%GOSUBL DISPMAINDROITE
GOLONG APRESKEYS

*SWAPMAINS
%LC5MGCHE-2
LC 00022
GOSUBL GONLEV1Ca
C=DAT1 A
D1=D1+ 4
C=DAT1 B
D1=D1- 2
DAT1=C 4
%GOSUBL DISPMAINDROITE
%GOSUBL DISPMAINGAUCHE
GOTO APRESKEYS

*CHECKMAIN&DIR
%AVANT DE PRENDRE/POSER/JETER
GOSUBL GOHOME
C=DAT1 A
R3=C A %R3=lDXXYYh
CSR A %C4=XXYY

GOSUBL C4LISCASE
%MAINTENANT
%A=QGQD&3F B=QGQD
%R0=çQG,R1=çQD
%R2=000LR,R4x=NCASE
%ST0=VALIDEJOUEUR
%ST1=VALIDEMONSTRE
%ST2=OV&M
%ST3=OBJPOSE

%LC5MDROITE
LC 00026
GOSUBL GONLEV1Ca
C=DAT1 B
RTN

*JETGAUCHE
ST=0 6
GOTO JET
*JETDROITE
ST=1 6
*JET
%LC2OBJVOL
LC 04
P= 4
GOSUBL GARANTITBLOC4LIBRE
GOSUB CHECKMAIN&DIR
?Cã0 B
GOYES JETPASMAINVIDE
GOTO PASJETMAINVIDE
*JETPASMAINVIDE
D=C B
%LC2OBJVOL
LC 04
P= 4
GOSUB NIVCCHERCHEBLOC4LIBRE
%ECRIRE XXYY(4)
%DIRV(1)
%N∞OBJ(2),ALT(1)
%COINPOS(1)
C=R3 A %XYCASE
CSR A
DAT0=C 4
D0=D0+ 4
C=R3 B %.dj
?ST=0 6
GOYES JETEAGAUCHE
C=C+1 B
CBIT=0 2
*JETEAGAUCHE
DAT0=C 1
D0=D0+ 1
C=D B
DAT0=C B
D0=D0+ 2
LC F %%ALTITUDE!
DAT0=C 1
D0=D0+ 1
C=R3 B %.dj
DAT0=C 1

GOSUB METBITOBJETVOLANTDANSPLAN

%OK OBJET PLUS DANS LA MAIN DROITE
%LC5MDROITE
LC 00026
GOSUBL GONLEV1Ca
C=0 B
DAT1=C B
%GOSUBL DISPMAINDROITE

ST=1 11
*PASJETMAINVIDE
GOTO APRESKEYS

*METBITOBJETVOLANTDANSPLAN
%MAINTENANT FLAGS
%DANS LE PLAN
%R0=çQG,R1=çQD

%SI ESCALIER
%IE VALIDE JOUEUR
%MAIS PAS MONSTRE
?ST=0 1
GOYES JET.PASMODIFBITS

C=R0 A
D0=C
C=DAT0 1
CBIT=0 3 %PRESENCE
%POSSIBLE OBJ&M
DAT0=C 1
*JET.PASMODIFBITS
RTN

*TOURNE.G
LC F3
*TOURNE
CSRC
CSRC
GOSUBL GOHOME
A=DAT1 S
A=A+C S
CSLC
A=A&C S
DAT1=A S
%AD1EX %INUTILERECUPD1
ST=1 11 %DISP IMPERATIF
GOTO APRESKEYS
*TOURNE.D
LC 13
GOTO TOURNE

*STEPê
P= 3 %3+1=4=0[4]
GOTO ONE.STEP
*STEPé
P= 2
GOTO ONE.STEP
*STEPè
P= 1
GOTO ONE.STEP
*STEPç
*ONE.STEP
GOSUBL GOHOME
%D0=C
C=DAT1 A
%P=DIRREL-1
C+P+1 %BIT0=DIRABS
P= 0
ACEX A
%A='D'XXYY
LC FFFF0
?ABIT=0 0
GOYES PASBIT0
CSL A
CSL A
C=-C A
*PASBIT0
?ABIT=0 1
GOYES PASBIT1
C=-C A
*PASBIT1
%C=0õXõY %A='D'XXYY
C=C+A A
CSR A %A=XXYY
%D=C A INUTILE
%FAIT PAR LA ROUTINE
%VERIFIONS CASE VALIDE
GOSUBL C4LISCASE
%%VERIF PAS MONSTRE SUR LA MEME CASE
ST=1 11 %DISP.IMPERATIF
?ST=0 0
GOYES CASENONJ
%LC 1B
%?A=C B
%GOYES CASENONJ

%ET MONSTRE?
C=D A
B=C A
%LC2MONSTR
LC 06
GOSUBL GOLEVCb
P= 15
GOSUBL SEEKB4ATFLUC
GONC APK
%VERIF SI TRANSPORT…
C=D A
B=C A
%LC2TRANS
LC 08
GOSUBL GOLEVCb
P= 14
GOSUBL SEEKB4ATFLUC
GOC STEPPASTRANS
%ON MET UN FLAG QUI
%DIT PAS DE TOUCHES
%AU PROCHAIN CYCLE!
ST=1 9
*STEPPASTRANS
*FINISTEP
GOSUBL GOHOME
D1=D1+ 1
C=D A
DAT1=C 4
*APK
GOTO APRESKEYS

*CASENONJ
GOSUBL CLS
GOSBVL 04999 %KINBUF?
GONC APK

GOSUB SUBEXTFOLLOW
$556213914052140
$C2A20
GOIN5 FINBOUMSTR
¢BOUM
*FINBOUMSTR
$E8C46E512144230
$CCD20
GOIN5 FINBIGCODE
GOSUB SAVEREG
GOTO APRESKEYS

*SETVUEAUTOUR
P= 1
GOTO SETQ11h
*SETVUEOBJ
P= 2
GOTO SETQ11h
*SETVUESANTE
P= 3
GOTO SETQ11h
*SETDODO
GOSUBL CLS
GOSUB SUBEXTFOLLOW
$556213914052140 %§42d §1F
$C2A20
GOIN5 FINSTRWKUP
¢ZZZ
*FINSTRWKUP
$E8C46E512144230
$CCD20
GOIN5 FINBIGCODE
GOSUB SAVEREG
%P= 0
*SETQ11h
C=P 15
P= 0
%LC5ETATDISP
LC 00011
GOSUBL GONLEV1Ca
DAT1=C S
ST=1 11 %DISP.IMPERATIF
GOTO APRESKEYS

*OFFKEY
GOSUB SUBEXTFOLLOW
$7A140
$CCD20
GOIN5 FINBIGCODE
GOSUB SAVEREG
ST=1 11
GOTO APRESKEYS

*MODIFQ
GOSUB SUBEXTFOLLOW
$0A024A21701192000100E0E30F80402CE300A024A21701192000100E0E30CBD30
$CCD20
GOIN5 FINBIGCODE
GOSBVL 06641
GOSBVL 0679B
C=A B
A=0 B
?A=0 A
GOYES PUTQ
GOTO BADKEY
*PUTQ0
LC 00
GOTO PUTQ
*PUTQ1
LC 10
*PUTQ
R2=C B
GOSUB CHECKMAIN&DIR
ST=1 4 %CASE SUIV
GOSUB CALCULECOINSOL
%C4LISCASE DONNE:
A=R2 B
C=R1 A
D1=C
DAT1=A 1
ASR B
C=R0 A
D1=C
DAT1=A 1
ST=1 11
GOTO APRESKEYS

%*INFOKEY
%GOSUB SUBEXTFOLLOW
%$88130D3B5108F1155621
%$300403004097611
%$CCD20
%GOIN5 FINBIGCODE
%GOSUB SAVEREG
%GOTO APRESKEYS

*PHOTOKEY
GOSUB SUBEXTFOLLOW
$55621 %LCDç
$E1B205000039150
%PATCH:NEWOB&CHG PROLOG
$79E6084E20500584F445F469680
%$11920E0000 %MAXARG+1
%$C4130 %DEPTH
%$E9330 %UPONSTACK
%MAINTENANT INDICATION
$556213914052140
$C2A20
GOIN5 FINPHOTOSTR
¢PHOTO TAKEN
*FINPHOTOSTR
$E8C46E512144230
$CCD20
GOIN5 FINBIGCODE
GOSUB SAVEREG
GOTO APRESKEYS

*TOUCHESAC
%Ba=N∞TOUCHE 000NN
%=N∞CASEDANSSAC+1
%Ah-1=9
%LC5MDROITE
LC 00026
GOSUBL GONLEV1Ca
D0=C %D0=MAINDROITE
B=B+B B
C=C+B A
D1=C %D1=OBJSAC
A=DAT0 B
C=DAT1 B
DAT0=C B
DAT1=A B
ST=1 11 %REDESSINER OBJETS
%GOSUBL DISPMAINDROITE
GOTO APRESKEYS

*CHANGEPOCHE
%Ba=N∞TOUCHE 000NN
%LC5PPOCHE-2
LC 0004A
GOSUBL GONLEV1Ca
%C=D1=AVANT1EPOCHE
CSLC
LC 6 %6 POCHES MAXI
CSRC
GOSUB CHERCHEPOCHE
GONC OKTROUVE1POCHE
LC 24
GOLONG ERRORCb
*OKTROUVE1POCHE
CD1EX
D1=C
D=C A %D=ANCIENNE POCHE
GOSUB CHERCHEPOCHE
GOC OK1SEULEPOCHE
LC 25
GOLONG ERRORCb
*OK1SEULEPOCHE
%LC5MDROITE
LC 00026
B=B+B A
C=C+B A
GOSUBL GONLEV1Ca
%C=NOUVEAU,D=ANCIEN
CDEX A %D=NOUVEAU,C=ANCIEN
D0=C %D0=ANCIEN
%LC5MDROITE
LC 00026
GOSUBL GONLEV1Ca
%D1=MAINDROITE
C=DAT1 B
DAT0=C B
C=D A
D0=C %D0=NOUVELLE
C=DAT0 B
DAT1=C B
LC 03
DAT0=C B
%GOSUBL DISPMAINDROITE
%ST=1 11 INUTILEè
GOSUBL DISPPOCHES
GOTO APRESKEYS

*CHERCHEPOCHE
LA 03
*CHERCHEENCORE
D1=D1+ 2
C=DAT1 B
C=C-1 S
?C=A B
GOYES TROUVEEPOCHE
?Cã0 S
GOYES CHERCHEENCORE
%PASTROUVE
RTNSC
*TROUVEEPOCHE
RTNCC
%%FIN MANIP SAC A DOS

*NEXTPOSOBJ
%CALCULE OŸ UN OBJET
%ARRIVE APRES DEPLACEMENT
%ENTREE
%Cs=(coin) As=(dir)
%B4=(CASE)
%SORTIE: NOUVELLES
%VALEURS DE Cs ET B4.
%As EST INCHANG….
%%?MODIF:CsCaBsB4D1Aa
%C4LISCASE EST APPEL…
%SI CHANGEMENT DE CASE
C=C-A S
C=-C-1 S
CSLC
?CBIT=1 1
GOYES CHGCAZ
%CHGPASCAZ
CSRC
C=C+A S
LA 3
ASRC
C=C&A S
ASLC
RTNCC
*CHGCAZ
CSRC
%VOYONS EN F(DIR)
B=A S %DIR

C=C+A S
LA 3
ASRC
C=C&A S
ASLC

LC 00100 %POUR SI õ EN X

B=B-1 S
GONC DIRNON0
B=B-1 A %0çREMONTE
GOTO ACHEVENEXTPOS
*DIRNON0
B=B-1 S
GONC DIRNON1
B=B+C A %1çDROITE
GOTO ACHEVENEXTPOS
*DIRNON1
B=B-1 S
GONC DIRNON2
B=B+1 A %BAS
GOTO ACHEVENEXTPOS
*DIRNON2
B=B-1 S
GONC DIRNON3
B=B-C A %GAUCHE
GOTO ACHEVENEXTPOS
*DIRNON3
%PAS NORMAL
LC 26
GOLONG ERRORCb
*ACHEVENEXTPOS
C=B A
R3=C A
GOSUBL C4LISCASE
C=R3 A
B=C A
RTNSC

*SOLGAUCHELOIN
*SOLDROITELOIN
*SOLGAUCHEPRES
*SOLDROITEPRES
ST=0 4 %PROCHE
ST=0 6 %GAUCHE
C=B B
?CBIT=0 0
GOYES PASDROITESOL
ST=1 6 %DROITE
*PASDROITESOL
?CBIT=1 1
GOYES PASLOINSOL
ST=1 4 %LOIN
*PASLOINSOL
%LC2OBPOSE
LC 05
P= 7
GOSUBL GARANTITBLOC4LIBRE
GOSUB CHECKMAIN&DIR
?Cã0 B
GOYES POSEOBJET
GOTO PRENDOBJET
*POSEOBJET
%ON VA CHERCHER
%UN BLOC CONCERNANT
%LA CASE DEST ET AVEC
%LE COIN LIBRE

GOSUB CALCULECOINSOL
?ST=1 0
GOYES CASEOKPOURPOSER
GOTO BADKEY
*CASEOKPOURPOSER
GOSUB CASECOINB4R2sDONNED0
%MAINTENANT D0b=DEST

%LC5MDROITE
LC 00026
GOSUBL GONLEV1Ca
C=DAT1 B %C=N∞OBJ
DAT0=C B

%MAIN VIDE
C=0 B
DAT1=C B
%GOSUBL DISPMAINDROITE

GOSUB POSE.METBITPRESENCEOBJPOSE

ST=1 11
GOTO APRESKEYS

*CASECOINB4R2sDONNED0
%SUPPOSE B4=XXYY
%R2s=N∞COIN
%TROUVE OU FABRIQUE
%UN BLOC AVEC CE COIN
%LIBRE. RENVOIE D0
%TEL QUE DAT0b=OBJ
%POSE L'OBJ.

C=B A
R3=C A %4 EN FAIT

%LC2OBPOSE
LC 05
GOSUBL GOLEVCb
*POSE.CHERCHEENCORE
D=C A %POUR RAVOIR C SI PAS DE BLOC OK
P= 7
GOSUBL SEEKB4ATFLUC
%NCçUNBLOCTROUVE
%CarryçPASDEBLOCTROUVE
GOC POSE.PASDEBLOCOK
D=C A %POUR SUITE RECHERCHE
*TROUV…CANDIDATBLOC
%VERIFIONS PLACE LIBRE
A=R2 S %COIN OU POSER
*POSE.TOURNEENCORE
A=A-1 S
GOC POSE.FINITOURNER
D0=D0+ 2
GOTO POSE.TOURNEENCORE
*POSE.FINITOURNER
C=DAT0 B
?C=0 B
RTNYES
C=D A
GOTO POSE.CHERCHEENCORE
*POSE.PASDEBLOCOK
%ON VA DEVOIR EN CREER UN ?
%CHERCHONS BLOC LIBRE
C=D A %DERNIER BLOC PRIS
P= 7
GOSUBL ADRCCHERCHEBLOC4LIBRE
%SI PB ERREUR DEJA DECLENCHEE
%SI ON EST ICI C BON.
%ECRIVONS N∞CASE
C=R3 A
DAT0=C 4 %XXYY
C=0 W %VIDE
D0=D0+ 4
DAT0=C 8
%ONTOURNE
GOTO TROUV…CANDIDATBLOC

*POSE.METBITPRESENCEOBJPOSE
%RESTE LE QUARTET A METTRE
%R0=çQG,R1=çQD

%VERIF PAS ESCALIER
?ST=0 1
GOYES POSE.PASMODFBITS
C=R0 A
D0=C
C=DAT0 1
CBIT=0 2 %PRESENCE
%POSSIBLE OBJPOSE
DAT0=C 1
*POSE.PASMODFBITS
RTN


*CALCULECOINSOL
%ONVACALCULERLECOIN
%ET LA CASE DEST
C=R3 A %C0=DIR GRACE A CHECKMAIN&DIR
A=C B
ASRC %As=DIRMOI
R1=A S %R1s=DIRMOI
?ST=0 6 
GOYES POZPASGAUCHE2
C=C+1 B
CBIT=0 2
*POZPASGAUCHE2
CSRC %Cs=COIN OBJ

%C=R3 A %CASEd DEJA
%CSR A %CASE  DEJA
B=C A

?ST=0 4
GOYES ELOIGNEPAS
GOSUB NEXTPOSOBJ
*ELOIGNEPAS
R2=C S %R2s=COIN
C=B A %B4=NEWPOS
CSLC
R3=C A %R3a=DXXYY
CSRC
GOSUBL C4LISCASE
C=R3 A
CSR A
B=C A
RTN

*PRENDOBJET
GOSUB CALCULECOINSOL

C=0 A  %LE DERNIER BLOC
R1=C A %PAS ENCORE TROUV…
%LC2OBJOSE
LC 05
GOSUBL GOLEVCb
*PREND.CHERCHEENCORE
P= 7
GOSUBL SEEKB4ATFLUC
D=C A %POUR SUITE RECHERCHE
%NCçUNBLOCTROUVE
%CçPASDEBLOCTROUVE
GOC PREND.PASDEBLOCOK
%VERIFIONS COIN OQP
C=DAT0 W
A=R2 S %COIN OU PRENDRE
*PREND.TOURNEENCORE
A=A-1 S
GOC PREND.FINITOURNER
CSRC
CSRC
GOTO PREND.TOURNEENCORE
*PREND.FINITOURNER
?Cã0 B
GOYES PREND.TROUVEEPLACE
C=D A
GOTO PREND.CHERCHEENCORE
*PREND.TROUVEEPLACE
CD0EX %C=DATA
R1=C A %DERNIER=ICI
C=D A
GOTO PREND.CHERCHEENCORE
*PREND.PASDEBLOCOK
%SI R1=0 AUCUN
%SINON R1=LE BON
C=R1 A
?Cã0 A
GOYES AUMOINSUNPRENABLE
GOTO BADKEY
*AUMOINSUNPRENABLE
D0=C %D0=çDATAs

%LC5MDROITE
LC 00026
GOSUBL GONLEV1Ca
C=R2 S %R2s=COIN OU POSER
C=C+C S
GOC ANORMAL.PREND
C=C+C S
GONC NORMAL.PREND
*ANORMAL.PREND
LC 27
GOLONG ERRORCb
*NORMAL.PREND
CSRB S
C=DAT0 8 %C=XXOBXXXX
P=C 15
A=0 W
ACEX P
DAT1=A P
D1=D1+ 1
P=P+1
ACEX P
DAT1=A P
DAT0=C 8 %C=XX00XXXX
P= 7
?Cã0 WP
GOYES BLOCENCOREUTILE
P= 0
D0=D0- 4
LC FFFE
DAT0=C 4 %BLOC LIBERE
*BLOCENCOREUTILE
P= 0

%GOSUBL DISPMAINDROITE

ST=1 11
GOTO APRESKEYS
*TOMBETOUT
GOSUB CYCLEOBJETS
GOTO APRESKEYS
@"