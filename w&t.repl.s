%%HP: T(0)A(R)F(.);
"%This file is licensed
%under GPL v2

%W&T.REPL.S
%AFFICHAGE MUR
%ET TELEPORT

*AGrCmurREPL
%MODIF
%Aw,Ba,Cw,Dw,D0,D1,P=0
%1+3RSTK

%APPEL:GOSUB
%A=PROLOG GROB
%C=DEBSTRMUR
%ST=0 0 çMUR
%ST=1 0 çTELEPORT

RSTK=C
D1=C %RSTK=D1=DEBSTR

%CHAINE=xxx ofs ofs 
%xxx=Ècart bmp-grb

%1Ë Ètape: placer coin
C=0 A
C=DAT1 X %ofs POSITION
C=C+A A
B=C A %B= %ADRçGRB

*NEXTLINE
C=RSTK
C=C+3 A
D1=C
A=0 A
A=DAT1 X %1e ligne
?Aã0 X
GOYES GOLINE
*EXITDRAWWALL
RTN
*GOLINE
RSTK=C
C=C+A A %C=ADRLECTLIGNE
D1=C %D1=ADRREAD
%LIGNE=x x x x xxxx
%dÈcal larg mskg mskd quartets

%B=ADRGROB
C=0 A
C=DAT1 1 %DECAL
D1=D1+ 1
C=C+B A
D0=C %D0=ADRo˘ECRIRE
GOSUB MASKBIT
C=DAT1 B %nbre q
D1=D1+ 1
P=C 0
%QD
P=P-1
GOC PASDEDATA
%*YADESDATA
?ST=0 0
GOYES QCNORMAL
%SAUVER D1
CD1EX
RSTK=C
GOSUB QCTELEPORT
%RESTAURER D1
C=RSTK
D1=C

GOTO CENTREFAIT
*QCNORMAL
%MUR:SIMPLE
A=DAT1 WP
DAT0=A WP
*CENTREFAIT
CD0EX
C+P+1
CD0EX
CD1EX
C+P+1
CD1EX
*PASDEDATA
GOSUB MASKBIT
%LIGNE ECRITE
*STOPLINE
P= 0
LC 00022
B=B+C A
GOTO NEXTLINE

*MASKBIT
%D0=ADRO˘ECR
%D1=OŸLIREMASK
%C=0 B ?WHY?
A=DAT1 B %MASK&QUART
D1=D1+ 2
?ST=1 0
GOYES MASKTELEPORT
%MUR
C=DAT0 1 %qDEST
C=C&A B
ASR B
C=C!A B %C=Q¿ECR
DAT0=C 1 %DONE
GOTO MASKCOMMON
*MASKTELEPORT
CD1EX
RSTK=C
%A=QUART.MASK
%C LIBRE
D1= 00104
C=DAT1 B
D=C B
C=DAT1 B
C=C!D B %C=3/4.3/4
A=A!C B %A=MASKor3/4
CSR B
C=C!A B %C=MASKor15/16
C=-C-1 B
D=C B
%A=MASKor3/4
%D=NOT(MASKor15/16)
C=DAT0 1 %qDEST
C=C&A B
C=C!D B
DAT0=C 1 %DONE
%RESTAURER D1
C=RSTK
D1=C
*MASKCOMMON
D0=D0+ 1
RTN
*QCTELEPORT
%PLUS SIMPLE QUE BORD
%EQUIVAUT ¿ MASK=0000
%DEST AND 3/4 OR 1/16
%C LIBRE
D1= 51111
CD1EX
D1= 00104
C=DAT1 4
D1=C %D1=ADRHASARD
C=DAT1 W
C=-C-1 W
D=C W
%DSRC
%C=C!D W %C=3/4
%D=C W PAS15/16MAIS7/8
DSRC
D=D!C WP %D=15/16NON
D=-D-1 WP %D=1/4

A=DAT0 WP %DEST
C=C&A WP
C=C!D WP
DAT0=C WP
RTN
@"